<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastramento Anual - COMESOL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-light: #60ad5e;
            --primary-dark: #005005;
            --secondary-color: #0277bd;
            --secondary-light: #58a5f0;
            --secondary-dark: #004c8c;
            --text-color: #333;
            --light-gray: #f5f5f5;
            --border-color: #ddd;
            --error-color: #d32f2f;
            --success-color: #388e3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(2, 119, 189, 0.2);
        }

        .error-message {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #b71c1c;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .member-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--light-gray);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .member-preview {
            font-size: 14px;
            color: #666;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 110px; /* leave space for logout button */
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }

        .status-connected {
            background-color: var(--success-color);
            color: white;
        }

        .status-disconnected {
            background-color: var(--error-color);
            color: white;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
        }

        .members-counter {
            margin: 15px 0;
            font-weight: 600;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .member-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .member-header button {
                margin-top: 10px;
            }
        }

        /* Modal de confirmação */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .modal-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 16px;
        }

        /* Tooltip for disabled buttons */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            display: none;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 2000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* Show tooltip only when the button is disabled and the wrapper is hovered or the wrapper has .show-tooltip */
        .tooltip-wrapper:hover button:disabled + .tooltip-text,
        .tooltip-wrapper.show-tooltip button:disabled + .tooltip-text {
            display: block;
        }
    </style>
</head>
<body>
    <div id="connection-status" class="connection-status hidden"></div>
    <button id="logout-btn" class="btn btn-danger hidden" style="position: fixed; top: 10px; right: 10px; z-index:1001;">Sair</button>

    <!-- Modal será criado dinamicamente quando necessário -->

    <!-- Página de Login -->
    <div id="login-page" class="container">
        <div class="login-container">
            <div class="card">
                <h1>Cadastramento Anual - COMESOL</h1>
                <p style="text-align: center; margin-bottom: 20px;">Faça login para acessar o sistema</p>
                
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" placeholder="Seu e-mail">
                    <div id="email-error" class="error-message">E-mail inválido</div>
                </div>
                
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Sua senha">
                    <div id="password-error" class="error-message">Senha é obrigatória</div>
                </div>
                
                <button id="login-btn" class="btn btn-primary" style="width: 100%;">Entrar</button>
                
                <p style="text-align: center; margin-top: 15px;">
                    Não tem conta? <a href="#" id="signup-link">Cadastre-se</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Página de Cadastro -->
    <div id="register-page" class="container hidden">
        <div class="card">
            <h1>Cadastro de Empreendimento</h1>
            
            <!-- Seção Informações do Grupo -->
            <div class="section">
                <h2>Informações do Grupo</h2>
                
                <div class="form-group">
                    <label for="group-name">Nome do grupo/empreendimento *</label>
                    <input type="text" id="group-name" placeholder="Nome do grupo">
                    <div id="group-name-error" class="error-message">Nome do grupo é obrigatório</div>
                </div>
                
                <div class="form-group">
                    <label for="representative-name">Nome do representante *</label>
                    <input type="text" id="representative-name" placeholder="Nome do representante">
                    <div id="representative-name-error" class="error-message">Nome do representante é obrigatório</div>
                </div>
                
                <div class="form-group">
                    <label for="contact-email">E-mail de contato *</label>
                    <input type="email" id="contact-email" placeholder="E-mail de contato">
                    <div id="contact-email-error" class="error-message">E-mail de contato é obrigatório</div>
                </div>
                
                <div class="form-group">
                    <label for="has-headquarters">Possui sede própria? *</label>
                    <select id="has-headquarters">
                        <option value="">Selecione</option>
                        <option value="sim">Sim</option>
                        <option value="nao">Não</option>
                    </select>
                    <div id="has-headquarters-error" class="error-message">Este campo é obrigatório</div>
                </div>
                
                <div id="headquarters-address-group" class="form-group hidden">
                    <label for="headquarters-address">Endereço completo da sede *</label>
                    <textarea id="headquarters-address" rows="3" placeholder="Endereço completo"></textarea>
                    <div id="headquarters-address-error" class="error-message">Endereço é obrigatório</div>
                </div>
            </div>
            
            <!-- Seção Cadastro dos Membros -->
            <div class="section">
                <h2>Cadastro dos Membros</h2>
                
                <!-- Subseção Dados Pessoais -->
                <div class="sub-section">
                    <h3>Dados Pessoais</h3>
                    
                    <div class="form-group">
                        <label for="member-name">Nome Completo *</label>
                        <input type="text" id="member-name" placeholder="Nome completo">
                        <div id="member-name-error" class="error-message">Nome completo é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="birth-date">Data de Nascimento *</label>
                        <input type="date" id="birth-date">
                        <div id="birth-date-error" class="error-message">Data de nascimento é obrigatória</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="mother-name">Nome da Mãe *</label>
                        <input type="text" id="mother-name" placeholder="Nome da mãe">
                        <div id="mother-name-error" class="error-message">Nome da mãe é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Endereço completo *</label>
                        <textarea id="address" rows="3" placeholder="Endereço completo"></textarea>
                        <div id="address-error" class="error-message">Endereço é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cep">CEP *</label>
                        <input type="text" id="cep" placeholder="00000-000" maxlength="9">
                        <div id="cep-error" class="error-message">CEP é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cpf">CPF *</label>
                        <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14">
                        <div id="cpf-error" class="error-message">CPF é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Celular *</label>
                        <input type="text" id="phone" placeholder="(00) 00000-0000" maxlength="15">
                        <div id="phone-error" class="error-message">Celular é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="member-email">E-mail *</label>
                        <input type="email" id="member-email" placeholder="E-mail">
                        <div id="member-email-error" class="error-message">E-mail é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="rg">RG</label>
                        <input type="text" id="rg" placeholder="RG (opcional)">
                    </div>
                    
                    <div class="form-group">
                        <label for="mei-cnpj">MEI/CNPJ</label>
                        <input type="text" id="mei-cnpj" placeholder="MEI/CNPJ (opcional)">
                    </div>
                </div>
                
                <!-- Subseção Dados Demográficos e Sociais -->
                <div class="sub-section">
                    <h3>Dados Demográficos e Sociais</h3>
                    
                    <div class="form-group">
                        <label for="gender">Gênero *</label>
                        <select id="gender">
                            <option value="">Selecione</option>
                            <option value="homem-cisgenero">Homem cisgênero</option>
                            <option value="mulher-cisgenero">Mulher cisgênero</option>
                            <option value="homem-transgenero">Homem transgênero</option>
                            <option value="mulher-transgenero">Mulher transgênero</option>
                            <option value="nao-binario">Não-Binário</option>
                            <option value="outro">Outro</option>
                        </select>
                        <div id="gender-error" class="error-message">Gênero é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ethnicity">Etnia/Cor *</label>
                        <select id="ethnicity">
                            <option value="">Selecione</option>
                            <option value="branco">Branco</option>
                            <option value="preto">Preto</option>
                            <option value="pardo">Pardo</option>
                            <option value="amarelo">Amarelo</option>
                            <option value="indigena">Indígena</option>
                        </select>
                        <div id="ethnicity-error" class="error-message">Etnia/Cor é obrigatória</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="education">Escolaridade *</label>
                        <select id="education">
                            <option value="">Selecione</option>
                            <option value="nao-alfabetizado">Não alfabetizado</option>
                            <option value="fundamental-incompleto">Fundamental incompleto</option>
                            <option value="fundamental-completo">Fundamental completo</option>
                            <option value="medio-incompleto">Médio incompleto</option>
                            <option value="medio-completo">Médio completo</option>
                            <option value="superior-incompleto">Superior incompleto</option>
                            <option value="superior-completo">Superior completo</option>
                            <option value="pos-graduacao">Pós Graduação</option>
                        </select>
                        <div id="education-error" class="error-message">Escolaridade é obrigatória</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="household-members">Quantas pessoas moram na sua casa? *</label>
                        <input type="number" id="household-members" min="1" placeholder="Número de pessoas">
                        <div id="household-members-error" class="error-message">Este campo é obrigatório</div>
                    </div>
                </div>
                
                <!-- Subseção Dados do Empreendimento e Renda -->
                <div class="sub-section">
                    <h3>Dados do Empreendimento e Renda</h3>
                    
                    <div class="form-group">
                        <label for="role">Qual sua função dentro do grupo? *</label>
                        <input type="text" id="role" placeholder="Ex.: coordenador, financeiro, marketing">
                        <div id="role-error" class="error-message">Função é obrigatória</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="products-services">Quais produtos ou serviços oferece? *</label>
                        <textarea id="products-services" rows="3" placeholder="Produtos ou serviços"></textarea>
                        <div id="products-services-error" class="error-message">Este campo é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="raw-materials">Quais matérias primas utiliza? *</label>
                        <textarea id="raw-materials" rows="3" placeholder="Matérias primas"></textarea>
                        <div id="raw-materials-error" class="error-message">Este campo é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="monthly-income">Qual a renda média mensal obtida no empreendimento? *</label>
                        <select id="monthly-income">
                            <option value="">Selecione</option>
                            <option value="ate-1-sm">Até 1 salário mínimo</option>
                            <option value="1-a-2-sm">1 a 2 salários mínimos</option>
                            <option value="2-a-3-sm">2 a 3 salários mínimos</option>
                            <option value="3-a-4-sm">3 a 4 salários mínimos</option>
                            <option value="mais-de-4-sm">Mais de 4 salários mínimos</option>
                        </select>
                        <div id="monthly-income-error" class="error-message">Renda mensal é obrigatória</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="involvement">Qual seu envolvimento com o movimento da economia solidária? *</label>
                        <textarea id="involvement" rows="3" placeholder="Envolvimento"></textarea>
                        <div id="involvement-error" class="error-message">Este campo é obrigatório</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="other-activities">Desenvolve outra atividade econômica além do empreendimento? *</label>
                        <select id="other-activities">
                            <option value="">Selecione</option>
                            <option value="sim">Sim</option>
                            <option value="nao">Não</option>
                        </select>
                        <div id="other-activities-error" class="error-message">Este campo é obrigatório</div>
                    </div>
                    
                    <div id="other-activities-details-group" class="form-group hidden">
                        <label for="other-activities-details">Qual outra atividade econômica? *</label>
                        <textarea id="other-activities-details" rows="3" placeholder="Descreva a outra atividade"></textarea>
                        <div id="other-activities-details-error" class="error-message">Este campo é obrigatório</div>
                    </div>
                </div>
                
                <button id="add-member-btn" class="btn btn-secondary">+ Adicionar Membro</button>
            </div>
            
            <!-- Lista de Membros Adicionados -->
            <div id="members-list" class="section">
                <h3>Membros Adicionados</h3>
                <div id="members-counter" class="members-counter">0 membros adicionados</div>
                <div id="members-container"></div>
            </div>
            
            <button id="save-group-btn" class="btn btn-primary" disabled>Salvar Cadastro do Grupo</button>
            <button id="edit-group-btn" class="btn btn-secondary hidden" style="margin-left:10px;">Editar Grupo</button>
        </div>
    </div>

    <!-- Página de Visualização -->
    <div id="view-page" class="container hidden">
        <div class="card">
            <div class="section-title">
                <h1>Visualização do Cadastro</h1>
                <button id="edit-btn" class="btn btn-secondary">Editar</button>
            </div>
            
            <!-- Informações do Grupo -->
            <div class="section">
                <h2>Informações do Grupo</h2>
                <div id="group-info-view"></div>
            </div>
            
            <!-- Membros do Grupo -->
            <div class="section">
                <h2>Membros do Grupo</h2>
                <div id="members-view"></div>
                <button id="add-new-member-btn" class="btn btn-secondary" style="margin-top: 15px;">+ Adicionar Novo Membro</button>
            </div>
            
            <button id="save-changes-btn" class="btn btn-primary hidden">Salvar Alterações</button>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://egarccprmvgqsvivnerc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnYXJjY3BybXZncXN2aXZuZXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjU0NTksImV4cCI6MjA3NDc0MTQ1OX0.Q_fdoeRnHx52EFOHIqk_icwe6auXDmmmLeJ266mSzEw';
        
        // Force Accept header to application/json to avoid potential 406 Not Acceptable
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            global: {
                headers: {
                    'Accept': 'application/json'
                }
            }
        });
        
        // Elementos da página
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const viewPage = document.getElementById('view-page');
        const connectionStatus = document.getElementById('connection-status');
        
    // Variáveis de estado
    let currentUser = null;
    let userGroup = null;
    let groupMembers = [];
    let deletedMemberIds = []; // ids marcados para remoção ao salvar
    let isEditing = false;
        
        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar conexão com o Supabase
            await checkSupabaseConnection();
            
            // Verificar se o usuário já está logado
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await checkUserRegistration();
            } else {
                showLoginPage();
            }
            
            // Configurar event listeners
            setupEventListeners();
            // Atualizar UI de autenticação (mostrar/esconder botão de logout)
            updateAuthUI();
        });
        
        // Verificar conexão com o Supabase
        async function checkSupabaseConnection() {
            try {
                // Fazer uma consulta simples para checar conectividade (evita requisições que causem 406)
                const restUrl = `${SUPABASE_URL}/rest/v1/groups?select=id&limit=1`;
                console.log('checkSupabaseConnection will call:', restUrl);

                const { data, error, status, statusText } = await supabase.from('groups').select('id').limit(1);

                if (error) {
                    // Logar detalhes para diagnóstico (inclui status/statusText quando disponível)
                    console.error('checkSupabaseConnection failed', { error, status, statusText });
                    try {
                        // alguns objetos de erro têm propriedades não enumeráveis; forçar serialização para inspecionar tudo
                        console.error('full error dump:', JSON.stringify(error, Object.getOwnPropertyNames(error), 2));
                    } catch (e) {
                        console.error('could not stringify error object', e);
                    }
                    showConnectionStatus(false, 'Erro de conexão com o banco de dados');
                    throw error;
                } else {
                    showConnectionStatus(true, 'Conectado ao banco de dados');
                }
            } catch (error) {
                console.error('Erro na conexão com Supabase:', error);
                showConnectionStatus(false, 'Erro de conexão com o banco de dados');
            }
        }
        
        // Mostrar status da conexão
        function showConnectionStatus(connected, message) {
            connectionStatus.textContent = message;
            connectionStatus.className = `connection-status ${connected ? 'status-connected' : 'status-disconnected'}`;
            connectionStatus.classList.remove('hidden');
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Login
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('signup-link').addEventListener('click', handleSignup);

            // Logout (abre modal dinamicamente)
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', showLogoutModal);
            
            // Cadastro do grupo
            document.getElementById('has-headquarters').addEventListener('change', toggleHeadquartersAddress);
            document.getElementById('other-activities').addEventListener('change', toggleOtherActivitiesDetails);

            // Atualizar estado do botão de salvar quando campos do grupo mudarem
            ['group-name', 'representative-name', 'contact-email', 'has-headquarters', 'headquarters-address'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const eventName = el.tagName.toLowerCase() === 'select' ? 'change' : 'input';
                el.addEventListener(eventName, () => {
                    // esconder mensagens de erro enquanto digita? manter validateGroupForm behavior
                    updateSaveGroupButtonState();
                });
            });
            
            // Máscaras de entrada
            document.getElementById('cep').addEventListener('input', formatCEP);
            document.getElementById('cpf').addEventListener('input', formatCPF);
            document.getElementById('phone').addEventListener('input', formatPhone);
            
            // Membros
            document.getElementById('add-member-btn').addEventListener('click', addMember);
            document.getElementById('save-group-btn').addEventListener('click', saveGroup);
            // Edit Group button (aparece após salvar e trava campos)
            const editGroupBtn = document.getElementById('edit-group-btn');
            if (editGroupBtn) editGroupBtn.addEventListener('click', () => {
                // Destravar campos do grupo para edição
                lockGroupFields(false);
                // mostrar o botão de salvar novamente para permitir atualização
                const saveGroupBtn = document.getElementById('save-group-btn');
                if (saveGroupBtn) saveGroupBtn.disabled = false;
                // esconder o botão editar enquanto estiver editando
                editGroupBtn.classList.add('hidden');
            });
            // Adicionar tooltips aos botões de salvar
            createTooltipForButton('save-group-btn', 'É necessário cadastrar pelo menos 1 membro para salvar o grupo');
            
            // Visualização/edição
            document.getElementById('edit-btn').addEventListener('click', enableEditing);
            document.getElementById('add-new-member-btn').addEventListener('click', addNewMember);
            document.getElementById('save-changes-btn').addEventListener('click', saveChanges);
            createTooltipForButton('save-changes-btn', 'É necessário cadastrar pelo menos 1 membro para salvar as alterações');
        }

        // Atualiza a UI relacionada à autenticação (mostrar/esconder botão logout)
        function updateAuthUI() {
            const logoutBtn = document.getElementById('logout-btn');
            if (!logoutBtn) return;

            // Não mostrar o botão de logout quando estivermos na página de login
            const loginVisible = !loginPage.classList.contains('hidden');

            // Mostrar botão de logout somente quando houver usuário autenticado e NÃO estivermos na página de login
            if (currentUser && !loginVisible) {
                logoutBtn.classList.remove('hidden');
            } else {
                logoutBtn.classList.add('hidden');
            }
        }

        // Realiza logout do Supabase e atualiza UI
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                currentUser = null;
                userGroup = null;
                groupMembers = [];
                showLoginPage();
                updateAuthUI();
            } catch (err) {
                console.error('Erro ao efetuar logout:', err);
                alert('Erro ao sair. Tente novamente.');
            }
        }

        // Mostrar/ocultar modal de logout
        function showLogoutModal() {
            // Não abrir o modal quando estivermos na página de login
            const loginVisible = !loginPage.classList.contains('hidden');
            if (loginVisible) return;

            // Criar modal dinamicamente
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'logout-modal';
            modal.setAttribute('aria-hidden', 'false');

            modal.innerHTML = `
                <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="logout-modal-title">
                    <h3 id="logout-modal-title">Confirmar saída</h3>
                    <p>Tem certeza que deseja sair da sua conta?</p>
                    <div class="modal-actions">
                        <button id="logout-cancel-btn" class="btn">Cancelar</button>
                        <button id="logout-confirm-btn" class="btn btn-danger">Sair</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Listeners dos botões
            const cancelBtn = document.getElementById('logout-cancel-btn');
            const confirmBtn = document.getElementById('logout-confirm-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', hideLogoutModal);
            if (confirmBtn) confirmBtn.addEventListener('click', async () => {
                hideLogoutModal();
                await handleLogout();
            });

            // Fechar com Escape
            const escHandler = (e) => {
                if (e.key === 'Escape') hideLogoutModal();
            };
            // armazenar no elemento para podermos remover depois
            modal._escHandler = escHandler;
            document.addEventListener('keydown', escHandler);

            // Colocar foco no botão confirmar
            if (confirmBtn) confirmBtn.focus();
        }

        function hideLogoutModal() {
            const modal = document.getElementById('logout-modal');
            if (!modal) return;

            // Remover listener de Escape
            if (modal._escHandler) document.removeEventListener('keydown', modal._escHandler);

            modal.remove();

            // Retornar foco para o botão de logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.focus();
        }

        // Helper para criar um wrapper com tooltip para botões desabilitados
        function createTooltipForButton(buttonId, tooltipText) {
            const btn = document.getElementById(buttonId);
            if (!btn) return;

            // Evitar duplicação
            if (btn.parentElement && btn.parentElement.classList.contains('tooltip-wrapper')) return;

            const wrapper = document.createElement('div');
            wrapper.className = 'tooltip-wrapper';

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip-text';
            tooltip.textContent = tooltipText;

            // Substituir o botão pelo wrapper contendo o botão
            btn.parentElement.replaceChild(wrapper, btn);
            wrapper.appendChild(btn);
            wrapper.appendChild(tooltip);

            // Mostrar tooltip quando o botão estiver desabilitado e o wrapper for focado (acessibilidade)
            wrapper.addEventListener('focusin', () => {
                if (btn.disabled) wrapper.classList.add('show-tooltip');
            });
            wrapper.addEventListener('focusout', () => wrapper.classList.remove('show-tooltip'));

            // Atualizar a visibilidade caso o estado do botão mude programaticamente
            const observer = new MutationObserver(() => {
                if (btn.disabled) wrapper.classList.add('disabled'); else wrapper.classList.remove('disabled');
            });
            observer.observe(btn, { attributes: true, attributeFilter: ['disabled'] });
        }
        
        // Funções de autenticação
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!validateEmail(email)) {
                showError('email-error', 'E-mail inválido');
                return;
            }
            
            if (!password) {
                showError('password-error', 'Senha é obrigatória');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                alert('Erro no login: ' + error.message);
            } else {
                currentUser = data.user;
                await checkUserRegistration();
            }
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!validateEmail(email)) {
                showError('email-error', 'E-mail inválido');
                return;
            }
            
            if (!password) {
                showError('password-error', 'Senha é obrigatória');
                return;
            }
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            });
            
            if (error) {
                alert('Erro no cadastro: ' + error.message);
            } else {
                alert('Cadastro realizado com sucesso! Verifique seu e-mail para confirmar a conta.');
            }
        }
        
        // Verificar se o usuário já tem cadastro
        async function checkUserRegistration() {
            try {
                // Fazemos uma query mínima primeiro (apenas id) para evitar problemas de content-negotiation que geram 406
                const { data: idOnly, error: idError } = await supabase
                    .from('groups')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .single();

                if (idError && idError.code !== 'PGRST116') {
                    console.error('Erro ao buscar id do grupo:', idError);
                    try { console.error('full error dump:', JSON.stringify(idError, Object.getOwnPropertyNames(idError), 2)); } catch (e) { console.error('could not stringify idError', e); }
                    return showRegisterPage();
                }

                if (!idOnly || !idOnly.id) {
                    // Nenhum grupo encontrado para o usuário
                    return showRegisterPage();
                }

                // Encontramos um id; buscar o registro completo por id (segunda etapa)
                const { data: full, error: fullError } = await supabase
                    .from('groups')
                    .select('*')
                    .eq('id', idOnly.id)
                    .single();

                if (fullError) {
                    console.error('Erro ao buscar grupo por id:', fullError);
                    try { console.error('full error dump:', JSON.stringify(fullError, Object.getOwnPropertyNames(fullError), 2)); } catch (e) { console.error('could not stringify fullError', e); }
                    return showRegisterPage();
                }

                userGroup = full;

                // Buscar membros do grupo
                const { data: membersData, error: membersError } = await supabase
                    .from('members')
                    .select('*')
                    .eq('group_id', userGroup.id);

                if (!membersError) {
                    groupMembers = membersData;
                }

                showViewPage();
            } catch (err) {
                console.error('Erro inesperado em checkUserRegistration:', err);
                try { console.error('full error dump:', JSON.stringify(err, Object.getOwnPropertyNames(err), 2)); } catch (e) { console.error('could not stringify err', e); }
                showRegisterPage();
            }
        }
        
        // Navegação entre páginas
        function showLoginPage() {
            loginPage.classList.remove('hidden');
            registerPage.classList.add('hidden');
            viewPage.classList.add('hidden');
        }
        
        function showRegisterPage() {
            loginPage.classList.add('hidden');
            registerPage.classList.remove('hidden');
            viewPage.classList.add('hidden');
            // Garantir que o estado do botão de salvar seja atualizado ao entrar na página de registro
            updateMembersList();
            // Se já existe um grupo carregado, preencher os campos e travá-los
            if (userGroup) {
                populateGroupFields();
                lockGroupFields(true);
                updateSaveGroupButtonState();
            }
        }

        // Preenche os campos do formulário de grupo a partir de userGroup
        function populateGroupFields() {
            if (!userGroup) return;
            document.getElementById('group-name').value = userGroup.name || '';
            document.getElementById('representative-name').value = userGroup.representative_name || '';
            document.getElementById('contact-email').value = userGroup.contact_email || '';
            // Se a coluna for boolean no DB, mapear para 'sim'/'nao' para o select
            const hasHQ = typeof userGroup.has_headquarters === 'boolean' ? (userGroup.has_headquarters ? 'sim' : 'nao') : (userGroup.has_headquarters || '');
            document.getElementById('has-headquarters').value = hasHQ;
            if (hasHQ === 'sim') {
                document.getElementById('headquarters-address-group').classList.remove('hidden');
                document.getElementById('headquarters-address').value = userGroup.headquarters_address || '';
            } else {
                document.getElementById('headquarters-address-group').classList.add('hidden');
                document.getElementById('headquarters-address').value = '';
            }
        }

        // Trava/destrava campos do grupo (true = travar)
        function lockGroupFields(lock) {
            const ids = ['group-name', 'representative-name', 'contact-email', 'has-headquarters', 'headquarters-address'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.disabled = !!lock;
            });

            // Se travar, também ocultar o botão de edição do grupo (se existir) — opcional
            const addMemberBtn = document.getElementById('add-member-btn');
            if (addMemberBtn) addMemberBtn.disabled = false; // sempre permitir adicionar membros

            const editGroupBtn = document.getElementById('edit-group-btn');
            if (editGroupBtn) {
                if (lock) {
                    // Quando os campos estiverem travados, exibir o botão de editar
                    editGroupBtn.classList.remove('hidden');
                } else {
                    editGroupBtn.classList.add('hidden');
                }
            }

            // Atualizar estado do botão de salvar (por exemplo: travado -> desabilitado)
            updateSaveGroupButtonState();
        }
        
        function showViewPage() {
            loginPage.classList.add('hidden');
            registerPage.classList.add('hidden');
            viewPage.classList.remove('hidden');
            renderGroupInfo();
            renderMembers();
        }
        
        // Toggle de campos condicionais
        function toggleHeadquartersAddress() {
            const hasHeadquarters = document.getElementById('has-headquarters').value;
            const addressGroup = document.getElementById('headquarters-address-group');
            
            if (hasHeadquarters === 'sim') {
                addressGroup.classList.remove('hidden');
            } else {
                addressGroup.classList.add('hidden');
            }
        }
        
        function toggleOtherActivitiesDetails() {
            const hasOtherActivities = document.getElementById('other-activities').value;
            const detailsGroup = document.getElementById('other-activities-details-group');
            
            if (hasOtherActivities === 'sim') {
                detailsGroup.classList.remove('hidden');
            } else {
                detailsGroup.classList.add('hidden');
            }
        }
        
        // Formatação de campos
        function formatCEP(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            e.target.value = value;
        }
        
        function formatCPF(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 3 && value.length <= 6) {
                value = value.substring(0, 3) + '.' + value.substring(3);
            } else if (value.length > 6 && value.length <= 9) {
                value = value.substring(0, 3) + '.' + value.substring(3, 6) + '.' + value.substring(6);
            } else if (value.length > 9) {
                value = value.substring(0, 3) + '.' + value.substring(3, 6) + '.' + value.substring(6, 9) + '-' + value.substring(9, 11);
            }
            e.target.value = value;
        }
        
        function formatPhone(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                value = '(' + value.substring(0, 2) + ') ' + value.substring(2);
            }
            if (value.length > 9) {
                value = value.substring(0, 10) + '-' + value.substring(10);
            }
            e.target.value = value;
        }
        
        // Validação de e-mail
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Mostrar/ocultar erro
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'none';
        }
        
        // Adicionar membro
        function addMember() {
            // Validar campos obrigatórios
            if (!validateMemberForm()) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            // Coletar dados do formulário
            const memberData = {
                name: document.getElementById('member-name').value,
                birth_date: document.getElementById('birth-date').value,
                mother_name: document.getElementById('mother-name').value,
                address: document.getElementById('address').value,
                cep: document.getElementById('cep').value,
                cpf: document.getElementById('cpf').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('member-email').value,
                rg: document.getElementById('rg').value,
                mei_cnpj: document.getElementById('mei-cnpj').value,
                gender: document.getElementById('gender').value,
                ethnicity: document.getElementById('ethnicity').value,
                education: document.getElementById('education').value,
                household_members: parseInt(document.getElementById('household-members').value),
                role: document.getElementById('role').value,
                products_services: document.getElementById('products-services').value,
                raw_materials: document.getElementById('raw-materials').value,
                monthly_income: document.getElementById('monthly-income').value,
                involvement: document.getElementById('involvement').value,
                other_activities: document.getElementById('other-activities').value,
                other_activities_details: document.getElementById('other-activities').value === 'sim' ? 
                    document.getElementById('other-activities-details').value : null
            };
            // Apenas adicionar localmente; a persistência ocorrerá quando o grupo for salvo
            groupMembers.push(memberData);
            updateMembersList();
            clearMemberForm();
        }
        
        // Validar formulário de membro
        function validateMemberForm() {
            let isValid = true;
            
            // Validar campos obrigatórios
            const requiredFields = [
                'member-name', 'birth-date', 'mother-name', 'address', 'cep', 'cpf',
                'phone', 'member-email', 'gender', 'ethnicity', 'education', 
                'household-members', 'role', 'products-services', 'raw-materials',
                'monthly-income', 'involvement', 'other-activities'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    isValid = false;
                    showError(`${fieldId}-error`, 'Este campo é obrigatório');
                } else {
                    hideError(`${fieldId}-error`);
                }
            });
            
            // Validações específicas
            if (document.getElementById('other-activities').value === 'sim' && 
                !document.getElementById('other-activities-details').value) {
                isValid = false;
                showError('other-activities-details-error', 'Este campo é obrigatório');
            } else {
                hideError('other-activities-details-error');
            }
            
            if (!validateEmail(document.getElementById('member-email').value)) {
                isValid = false;
                showError('member-email-error', 'E-mail inválido');
            }
            
            return isValid;
        }
        
        // Limpar formulário de membro
        function clearMemberForm() {
            const memberForm = document.getElementById('register-page');
            const inputs = memberForm.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                // Não limpar campos da seção de informações do grupo
                if (!input.closest('.section:first-child')) {
                    input.value = '';
                }
            });
            
            // Resetar campos condicionais
            document.getElementById('headquarters-address-group').classList.add('hidden');
            document.getElementById('other-activities-details-group').classList.add('hidden');
        }
        
        // Atualizar lista de membros
        function updateMembersList() {
            const container = document.getElementById('members-container');
            const counter = document.getElementById('members-counter');
            
            // Atualizar contador
            counter.textContent = `${groupMembers.length} membro(s) adicionado(s)`;
            
            // Limpar container
            container.innerHTML = '';
            
            // Adicionar cada membro
            groupMembers.forEach((member, index) => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                memberCard.innerHTML = `
                    <div class="member-header">
                        <h4>${member.name}</h4>
                        <button class="btn btn-danger delete-member" data-index="${index}">
                            🗑️ Excluir
                        </button>
                    </div>
                    <div class="member-preview">
                        <p><strong>Função:</strong> ${member.role}</p>
                        <p><strong>E-mail:</strong> ${member.email}</p>
                        <p><strong>Celular:</strong> ${member.phone}</p>
                    </div>
                `;
                
                container.appendChild(memberCard);
            });
            
            // Adicionar event listeners para botões de exclusão
            document.querySelectorAll('.delete-member').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const member = groupMembers[index];
                    // Se membro persistido no DB (possui id), marcar para remoção ao salvar
                    if (member && member.id) {
                        deletedMemberIds.push(member.id);
                        groupMembers.splice(index, 1);
                        updateMembersList();
                    } else {
                        groupMembers.splice(index, 1);
                        updateMembersList();
                    }

                    // (estado do botão agora é centralizado em updateMembersList())
                });
            });

            // Atualizar estado do botão de salvar cadastro do grupo: única regra = pelo menos 1 membro local
            const saveGroupBtn = document.getElementById('save-group-btn');
            if (saveGroupBtn) {
                // Use helper to decide enabled state (group form valid AND at least 1 member) and consider locked fields
                updateSaveGroupButtonState();
            }
        }

        // Habilita/desabilita o botão de salvar grupo baseado em validação do formulário de grupo e presença de membros
        function updateSaveGroupButtonState() {
            const saveGroupBtn = document.getElementById('save-group-btn');
            if (!saveGroupBtn) return;

            // if fields are locked, keep save disabled
            const firstField = document.getElementById('group-name');
            if (firstField && firstField.disabled) {
                saveGroupBtn.disabled = true;
                return;
            }

            const formValid = validateGroupForm();
            const hasMembers = groupMembers && groupMembers.length > 0;

            saveGroupBtn.disabled = !(formValid && hasMembers);
        }
        
        // Salvar grupo
        async function saveGroup() {
            // Regras mínimas antes de tentar salvar
            if (!groupMembers || groupMembers.length === 0) {
                alert('É necessário adicionar pelo menos 1 membro antes de salvar o grupo.');
                return;
            }

            if (!currentUser) {
                alert('Usuário não autenticado. Faça login novamente e tente salvar.');
                return;
            }

            // Validar campos do grupo
            if (!validateGroupForm()) {
                alert('Por favor, corrija os campos do grupo antes de salvar.');
                return;
            }

            // Coletar dados do grupo
            const groupData = {
                user_id: currentUser.id,
                name: document.getElementById('group-name').value,
                representative_name: document.getElementById('representative-name').value,
                contact_email: document.getElementById('contact-email').value,
                // Map select value ('sim'/'nao') to boolean for the DB column
                has_headquarters: document.getElementById('has-headquarters').value === 'sim',
                headquarters_address: document.getElementById('has-headquarters').value === 'sim' ? 
                    document.getElementById('headquarters-address').value : null
            };

            try {
                // Salvar ou atualizar grupo no Supabase
                let group;
                if (userGroup && userGroup.id) {
                    const { data, error } = await supabase
                        .from('groups')
                        .update(groupData)
                        .eq('id', userGroup.id)
                        .select()
                        .single();
                    if (error) throw new Error('Erro ao atualizar grupo: ' + (error.message || JSON.stringify(error)));
                    group = data;
                } else {
                    const { data, error } = await supabase
                        .from('groups')
                        .insert([groupData])
                        .select()
                        .single();
                    if (error) throw new Error('Erro ao inserir grupo: ' + (error.message || JSON.stringify(error)));
                    group = data;
                }

                userGroup = group;

                // Processar deleções marcadas (se houver)
                if (deletedMemberIds.length > 0) {
                    const { error: deleteError } = await supabase.from('members').delete().in('id', deletedMemberIds);
                    if (deleteError) throw new Error('Erro ao deletar membros: ' + (deleteError.message || JSON.stringify(deleteError)));
                    deletedMemberIds = [];
                }

                // Upsert (inserir novos e atualizar existentes) todos os membros atuais associados ao grupo
                const toUpsert = groupMembers.map(m => ({ ...m, group_id: group.id, user_id: currentUser.id }));
                if (toUpsert.length > 0) {
                    const { error: membersError } = await supabase.from('members').upsert(toUpsert);
                    if (membersError) throw new Error('Erro ao upsertar membros: ' + (membersError.message || JSON.stringify(membersError)));
                }

                // Recarregar membros do banco para garantir estado consistente
                const { data: membersData, error: membersFetchError } = await supabase.from('members').select('*').eq('group_id', group.id);
                if (membersFetchError) throw new Error('Erro ao buscar membros: ' + (membersFetchError.message || JSON.stringify(membersFetchError)));
                if (membersData) {
                    groupMembers = membersData;
                }

                alert('Cadastro salvo com sucesso! Campos do grupo travados para edição.');
                // Preencher e travar campos do grupo na página de registro
                populateGroupFields();
                lockGroupFields(true);
                // Atualizar lista de membros
                updateMembersList();

            } catch (error) {
                console.error('Erro ao salvar cadastro:', error);
                // Mostrar mensagem mais detalhada para ajudar debug
                const msg = error && error.message ? error.message : JSON.stringify(error);
                alert('Erro ao salvar cadastro: ' + msg);
            }
        }
        
        // Validar formulário do grupo
        function validateGroupForm() {
            let isValid = true;
            
            // Validar campos obrigatórios
            const requiredFields = ['group-name', 'representative-name', 'contact-email', 'has-headquarters'];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    isValid = false;
                    showError(`${fieldId}-error`, 'Este campo é obrigatório');
                } else {
                    hideError(`${fieldId}-error`);
                }
            });
            
            // Validações específicas
            if (!validateEmail(document.getElementById('contact-email').value)) {
                isValid = false;
                showError('contact-email-error', 'E-mail inválido');
            }
            
            if (document.getElementById('has-headquarters').value === 'sim' && 
                !document.getElementById('headquarters-address').value) {
                isValid = false;
                showError('headquarters-address-error', 'Endereço é obrigatório');
            }
            
            return isValid;
        }
        
        // Renderizar informações do grupo na página de visualização
        function renderGroupInfo() {
            const container = document.getElementById('group-info-view');
            
            if (!userGroup) return;
            
            container.innerHTML = `
                <p><strong>Nome do Grupo:</strong> ${userGroup.name}</p>
                <p><strong>Representante:</strong> ${userGroup.representative_name}</p>
                <p><strong>E-mail de Contato:</strong> ${userGroup.contact_email}</p>
                <p><strong>Possui Sede Própria:</strong> ${(typeof userGroup.has_headquarters === 'boolean' ? (userGroup.has_headquarters ? 'Sim' : 'Não') : (userGroup.has_headquarters === 'sim' ? 'Sim' : 'Não'))}</p>
                ${(typeof userGroup.has_headquarters === 'boolean' ? (userGroup.has_headquarters ? `<p><strong>Endereço da Sede:</strong> ${userGroup.headquarters_address}</p>` : '') : (userGroup.has_headquarters === 'sim' ? `<p><strong>Endereço da Sede:</strong> ${userGroup.headquarters_address}</p>` : ''))}
            `;
        }
        
        // Renderizar membros na página de visualização
        function renderMembers() {
            const container = document.getElementById('members-view');
            
            if (!groupMembers || groupMembers.length === 0) {
                container.innerHTML = '<p>Nenhum membro cadastrado.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            groupMembers.forEach((member, index) => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                memberCard.innerHTML = `
                    <div class="member-header">
                        <h4>${member.name}</h4>
                        ${isEditing ? 
                            `<button class="btn btn-danger delete-member-view" data-index="${index}">
                                🗑️ Excluir
                            </button>` : ''}
                    </div>
                    <div class="member-details">
                        <p><strong>Data de Nascimento:</strong> ${formatDate(member.birth_date)}</p>
                        <p><strong>Nome da Mãe:</strong> ${member.mother_name}</p>
                        <p><strong>Endereço:</strong> ${member.address}</p>
                        <p><strong>CEP:</strong> ${member.cep}</p>
                        <p><strong>CPF:</strong> ${member.cpf}</p>
                        <p><strong>Celular:</strong> ${member.phone}</p>
                        <p><strong>E-mail:</strong> ${member.email}</p>
                        ${member.rg ? `<p><strong>RG:</strong> ${member.rg}</p>` : ''}
                        ${member.mei_cnpj ? `<p><strong>MEI/CNPJ:</strong> ${member.mei_cnpj}</p>` : ''}
                        <p><strong>Gênero:</strong> ${formatGender(member.gender)}</p>
                        <p><strong>Etnia/Cor:</strong> ${formatEthnicity(member.ethnicity)}</p>
                        <p><strong>Escolaridade:</strong> ${formatEducation(member.education)}</p>
                        <p><strong>Pessoas na Casa:</strong> ${member.household_members}</p>
                        <p><strong>Função no Grupo:</strong> ${member.role}</p>
                        <p><strong>Produtos/Serviços:</strong> ${member.products_services}</p>
                        <p><strong>Matérias Primas:</strong> ${member.raw_materials}</p>
                        <p><strong>Renda Mensal:</strong> ${formatIncome(member.monthly_income)}</p>
                        <p><strong>Envolvimento com Economia Solidária:</strong> ${member.involvement}</p>
                        <p><strong>Outra Atividade Econômica:</strong> ${member.other_activities === 'sim' ? 'Sim' : 'Não'}</p>
                        ${member.other_activities === 'sim' ? 
                            `<p><strong>Detalhes da Outra Atividade:</strong> ${member.other_activities_details}</p>` : ''}
                    </div>
                `;
                
                container.appendChild(memberCard);
            });
            
            // Adicionar event listeners para botões de exclusão se estiver editando
            if (isEditing) {
                document.querySelectorAll('.delete-member-view').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        groupMembers.splice(index, 1);
                        renderMembers();
                    });
                });
            }

            // Atualizar estado do botão de salvar alterações: única regra = pelo menos 1 membro local
            const saveChangesBtn = document.getElementById('save-changes-btn');
            if (isEditing) {
                saveChangesBtn.disabled = groupMembers.length === 0;
            }
        }
        
        // Funções auxiliares de formatação
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        function formatGender(gender) {
            const genders = {
                'homem-cisgenero': 'Homem cisgênero',
                'mulher-cisgenero': 'Mulher cisgênero',
                'homem-transgenero': 'Homem transgênero',
                'mulher-transgenero': 'Mulher transgênero',
                'nao-binario': 'Não-Binário',
                'outro': 'Outro'
            };
            return genders[gender] || gender;
        }
        
        function formatEthnicity(ethnicity) {
            const ethnicities = {
                'branco': 'Branco',
                'preto': 'Preto',
                'pardo': 'Pardo',
                'amarelo': 'Amarelo',
                'indigena': 'Indígena'
            };
            return ethnicities[ethnicity] || ethnicity;
        }
        
        function formatEducation(education) {
            const educations = {
                'nao-alfabetizado': 'Não alfabetizado',
                'fundamental-incompleto': 'Fundamental incompleto',
                'fundamental-completo': 'Fundamental completo',
                'medio-incompleto': 'Médio incompleto',
                'medio-completo': 'Médio completo',
                'superior-incompleto': 'Superior incompleto',
                'superior-completo': 'Superior completo',
                'pos-graduacao': 'Pós Graduação'
            };
            return educations[education] || education;
        }
        
        function formatIncome(income) {
            const incomes = {
                'ate-1-sm': 'Até 1 salário mínimo',
                '1-a-2-sm': '1 a 2 salários mínimos',
                '2-a-3-sm': '2 a 3 salários mínimos',
                '3-a-4-sm': '3 a 4 salários mínimos',
                'mais-de-4-sm': 'Mais de 4 salários mínimos'
            };
            return incomes[income] || income;
        }
        
        // Habilitar edição
        function enableEditing() {
            isEditing = true;
            document.getElementById('edit-btn').classList.add('hidden');
            document.getElementById('save-changes-btn').classList.remove('hidden');
            document.getElementById('add-new-member-btn').classList.remove('hidden');
            renderMembers();
        }
        
        // Adicionar novo membro (na página de visualização/edição)
        function addNewMember() {
            showRegisterPage();
            // Aqui você poderia implementar uma lógica para preencher automaticamente
            // os dados do grupo se já existirem
        }
        
        // Salvar alterações
        async function saveChanges() {
            try {
                // Atualizar informações do grupo (se necessário)
                // Neste exemplo, não estamos permitindo edição das informações do grupo
                // Mas você pode implementar essa funcionalidade se necessário
                
                // Atualizar membros
                // Primeiro, excluir membros removidos
                // Em uma implementação real, você precisaria comparar com os membros existentes no banco
                
                // Primeiro processar deleções marcadas (se houver)
                if (deletedMemberIds.length > 0) {
                    const { error: deleteError } = await supabase.from('members').delete().in('id', deletedMemberIds);
                    if (deleteError) throw deleteError;
                    deletedMemberIds = [];
                }

                // Upsert (inserir novos e atualizar existentes) todos os membros atuais associados ao grupo
                const toUpsert = groupMembers.map(m => ({ ...m, group_id: userGroup.id, user_id: currentUser.id }));
                if (toUpsert.length > 0) {
                    const { error: membersError } = await supabase.from('members').upsert(toUpsert);
                    if (membersError) throw membersError;
                }
                
                alert('Alterações salvas com sucesso!');
                isEditing = false;
                document.getElementById('edit-btn').classList.remove('hidden');
                document.getElementById('save-changes-btn').classList.add('hidden');
                document.getElementById('add-new-member-btn').classList.add('hidden');
                renderMembers();
                
            } catch (error) {
                console.error('Erro ao salvar alterações:', error);
                alert('Erro ao salvar alterações. Tente novamente.');
            }
        }
    </script>
</body>
</html>